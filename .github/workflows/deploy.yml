name: ğŸš€ Deploy Xpress.Delivery MVP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-js-version: '18'
        
    - name: ğŸ“‹ Validate configuration
      run: |
        echo "ğŸ” Validating application configuration..."
        # Basic validation - check if files exist and are valid
        if [ ! -f "index-modular.html" ]; then
          echo "âŒ Main application file not found"
          exit 1
        fi
        if [ ! -f "src/config/env.config.js" ]; then
          echo "âŒ Environment configuration not found"
          exit 1
        fi
        echo "âœ… Application configuration valid"

    - name: ğŸ”‘ Setup SSH key for deployment
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ” Setting up SSH key for borg.tools..."
        mkdir -p ~/.ssh
        echo "${{ secrets.BORG_TOOLS_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H borg.tools >> ~/.ssh/known_hosts
        echo "âœ… SSH key configured"

    - name: ğŸš€ Deploy to borg.tools
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸš€ Deploying to production server (sendxpress.borg.tools)..."
        ssh vizi@borg.tools './deploy.sh sendxpress main'
        echo "âœ… Deployment completed"

    - name: ğŸ§ª Test deployment
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        echo "ğŸ§ª Testing production deployment..."
        sleep 5
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://sendxpress.borg.tools)
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Production site is responding (HTTP $HTTP_CODE)"
        else
          echo "âš ï¸ Production site returned HTTP $HTTP_CODE"
        fi

  security-check:
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¦ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Check for secrets in code
      run: |
        echo "ğŸ” Scanning for potential secrets in committed files..."
        
        # Check for common secret patterns
        if grep -r "wojciech@xpress.delivery" xpress-mvp/ --exclude-dir=node_modules --exclude="*.log" || true; then
          echo "âš ï¸ Found hardcoded email in committed files"
        fi
        
        if grep -r "dupa8dupa" xpress-mvp/ --exclude-dir=node_modules --exclude="*.log" || true; then
          echo "âŒ Found hardcoded password in committed files - SECURITY ISSUE!"
          exit 1
        fi
        
        if grep -r "AIzaSy" xpress-mvp/ --exclude-dir=node_modules --exclude="*.log" --exclude=".env.*" || true; then
          echo "âš ï¸ Found potential Google API key in committed files"
        fi
        
        echo "âœ… Security scan completed"
        
    - name: ğŸ“‹ Validate .gitignore
      run: |
        echo "ğŸ” Checking .gitignore configuration..."
        if grep -q "\.env" xpress-mvp/.gitignore; then
          echo "âœ… .env files are gitignored"
        else
          echo "âŒ .env files not in .gitignore - SECURITY ISSUE!"
          exit 1
        fi
        
        if grep -q "config\.local\.js" xpress-mvp/.gitignore; then
          echo "âœ… Local config files are gitignored"
        else
          echo "âš ï¸ Local config files should be gitignored"
        fi
        
        echo "âœ… .gitignore validation completed"